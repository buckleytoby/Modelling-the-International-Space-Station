<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T2U3">u</span>, <span class="var type1" id="S3T23U4">Kq</span>, <span class="var type1" id="S4T13U5">Kw</span>, <span class="var type1" id="S5T3U6">timePass1</span>]  = fcn(<span class="var type1" id="S6T1U9">state</span>, <span class="var type1" id="S7T2U10">w_des</span>, <span class="var type1" id="S8T2U11">w</span>, <span class="var type1" id="S9T13U12">PHI</span>, <span class="var type1" id="S10T13U13">Beuler</span>, <span class="var type1" id="S11T13U14">A_DCM</span>, <span class="var type1" id="S12T3U15">timePass</span>, <span class="var type1" id="S13T23U16">Kq_old</span>, <span class="var type1" id="S14T13U17">Kw_old</span>, <span class="var type1" id="S15T3U18">dt</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% x = [quat; ang vel]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo " id="T13:U15"><span class="var type1" id="S16T13U21">triad1</span> = <span class="mxinfo " id="T13:U17"><span class="fcn" id="F2N6:B23">getRTNTriadfromState</span>( <span class="var type1" id="S6T1U24">state</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo " id="T13:U19"><span class="var type1" id="S18T13U27">A_RTN</span> = <span class="mxinfo " id="T13:U21"><span class="fcn" id="F42N5:B29">getDCM</span>(<span class="var type1" id="S16T13U30">triad1</span>, <span class="mxinfo " id="T13:U23">eye(3)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line">coder.extrinsic(<span class="string">'dcm2quat'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo " id="T22:U24"><span class="var type1" id="S22T22U42">q_des</span> = coder.nullcopy(<span class="mxinfo " id="T22:U26">zeros(<span class="mxinfo " id="T3:U27">4</span>,1)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo " id="T22:U28"><span class="var type1" id="S24T22U53">q</span> = coder.nullcopy(<span class="mxinfo " id="T22:U30">zeros(<span class="mxinfo " id="T3:U31">4</span>,1)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo " id="T22:U32"><span class="var type1" id="S22T22U64">q_des</span> = <span class="mxinfo " id="T25:U34"><span class="extrinsicFcn" id="F67N2:B66">dcm2quat</span>(<span class="mxinfo " id="T13:U35">[<span class="mxinfo " id="T2:U36"><span class="mxinfo " id="T26:U37">[<span class="mxinfo " id="T3:U38">1</span> <span class="mxinfo " id="T3:U39">0</span> <span class="mxinfo " id="T3:U40">0</span>]</span>'</span> <span class="mxinfo " id="T2:U41"><span class="mxinfo " id="T26:U42">[<span class="mxinfo " id="T3:U43">0</span> <span class="mxinfo " id="T3:U44">0</span> <span class="mxinfo " id="T3:U45">1</span>]</span>'</span> <span class="mxinfo " id="T2:U46"><span class="mxinfo " id="T26:U47">[<span class="mxinfo " id="T3:U48">0</span> <span class="mxinfo " id="T3:U49">1</span> <span class="mxinfo " id="T3:U50">0</span>]</span>'</span>]</span>)</span></span>; <span class="comment">%dcm2quat(A_RTN);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo " id="T22:U51"><span class="var type1" id="S24T22U89">q</span> = <span class="mxinfo " id="T25:U53"><span class="extrinsicFcn" id="F68N2:B91">dcm2quat</span>(<span class="var type1" id="S11T13U92">A_DCM</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line">coder.extrinsic(<span class="string">'dlqr'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line">coder.extrinsic(<span class="string">'lqr'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T5:U55"><span class="var type1" id="S12T3U108">timePass</span> &gt; <span class="mxinfo " id="T3:U57"><span class="mxinfo " id="T3:U58">100</span>*<span class="var type1" id="S15T3U111">dt</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line">  [<span class="mxinfo " id="T23:U60"><span class="var type1" id="S26T23U115">Aquat</span></span>, <span class="mxinfo " id="T24:U62"><span class="var type1" id="S27T24U116">Aee</span></span>, <span class="mxinfo " id="T24:U64"><span class="var type1" id="S28T24U117">Bquat</span></span>] = <span class="fcn" id="F69N7:B119">linearQuat</span>( <span class="var type1" id="S24T22U120">q</span>, <span class="var type1" id="S8T2U121">w</span>, <span class="var type1" id="S15T3U122">dt</span>, <span class="var type1" id="S10T13U123">Beuler</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line">  <span class="mxinfo " id="T23:U70"><span class="var type1" id="S30T23U126">A</span> = <span class="mxinfo " id="T23:U72"><span class="var type1" id="S15T3U128">dt</span>*<span class="mxinfo " id="T23:U74">eye(4)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line">  <span class="mxinfo " id="T23:U75"><span class="var type1" id="S31T23U134">B</span> = <span class="mxinfo " id="T23:U77">[<span class="mxinfo " id="T27:U78">zeros(4,1)</span>, <span class="var type1" id="S27T24U141">Aee</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">  <span class="mxinfo " id="T23:U80"><span class="var type1" id="S32T23U144">C</span> = <span class="mxinfo " id="T23:U82">eye(4)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">  <span class="mxinfo " id="T3:U83"><span class="var type1" id="S33T3U150">p</span> = <span class="mxinfo " id="T3:U85">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line">  <span class="mxinfo " id="T23:U86"><span class="var type1" id="S34T23U154">Q</span> = <span class="mxinfo " id="T23:U88"><span class="mxinfo " id="T3:U89"><span class="var type1" id="S33T3U156">p</span></span>*(<span class="mxinfo " id="T23:U91"><span class="var type1" id="S32T23U160">C</span>'*<span class="var type1" id="S32T23U161">C</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line">  <span class="mxinfo " id="T23:U94"><span class="var type1" id="S35T23U164">R</span> = <span class="mxinfo " id="T23:U96">eye(size(<span class="var type1" id="S31T23U169">B</span>,2))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">  <span class="mxinfo " id="T23:U98"><span class="var type1" id="S3T23U173">Kq</span> = coder.nullcopy(<span class="mxinfo " id="T23:U100">zeros(<span class="mxinfo " id="T3:U101">4</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">  <span class="mxinfo " id="T23:U102"><span class="var type1" id="S3T23U183">Kq</span> = <span class="mxinfo " id="T25:U104"><span class="extrinsicFcn" id="F97N3:B185">dlqr</span>(<span class="var type1" id="S30T23U186">A</span>,<span class="var type1" id="S31T23U187">B</span>,<span class="var type1" id="S34T23U188">Q</span>,<span class="var type1" id="S35T23U189">R</span>)</span></span>; <span class="comment">%discrete lqr, x_k+1 = A*x_k+B*u_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line">  <span class="mxinfo " id="T22:U109"><span class="var type1" id="S38T22U192">out</span> = <span class="mxinfo " id="T22:U111"><span class="mxinfo " id="T23:U112">-<span class="var type1" id="S3T23U195">Kq</span></span>*(<span class="mxinfo " id="T22:U114"><span class="var type1" id="S24T22U198">q</span> - <span class="var type1" id="S22T22U199">q_des</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">  <span class="mxinfo " id="T2:U117"><span class="var type1" id="S7T2U202">w_des</span> = <span class="mxinfo " id="T2:U119"><span class="var type1" id="S38T22U204">out</span>(<span class="mxinfo " id="T26:U121"><span class="mxinfo " id="T3:U122">2</span>:<span class="mxinfo " id="T3:U123">4</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">  <span class="mxinfo " id="T13:U124"><span class="var type1" id="S30T13U210">A</span> = <span class="var type1" id="S9T13U211">PHI</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">  <span class="mxinfo " id="T13:U127"><span class="var type1" id="S31T13U214">B</span> = <span class="var type1" id="S10T13U215">Beuler</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">  <span class="mxinfo " id="T13:U130"><span class="var type1" id="S32T13U218">C</span> = <span class="mxinfo " id="T13:U132">eye(3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">  <span class="mxinfo " id="T13:U133"><span class="var type1" id="S34T13U224">Q</span> = <span class="mxinfo " id="T13:U135"><span class="mxinfo " id="T3:U136"><span class="var type1" id="S33T3U226">p</span></span>*(<span class="mxinfo " id="T13:U138"><span class="var type1" id="S32T13U230">C</span>'*<span class="var type1" id="S32T13U231">C</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">  <span class="mxinfo " id="T13:U141"><span class="var type1" id="S35T13U234">R</span> = <span class="mxinfo " id="T13:U143">eye(size(<span class="var type1" id="S31T13U239">B</span>,2))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">  <span class="mxinfo " id="T13:U145"><span class="var type1" id="S4T13U243">Kw</span> = coder.nullcopy(<span class="mxinfo " id="T13:U147">zeros(<span class="mxinfo " id="T3:U148">3</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">  <span class="mxinfo " id="T13:U149"><span class="var type1" id="S4T13U253">Kw</span> = <span class="mxinfo " id="T25:U151"><span class="extrinsicFcn" id="F134N3:B255">dlqr</span>(<span class="var type1" id="S30T13U256">A</span>,<span class="var type1" id="S31T13U257">B</span>,<span class="var type1" id="S34T13U258">Q</span>,<span class="var type1" id="S35T13U259">R</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">  <span class="mxinfo " id="T2:U156"><span class="var type1" id="S2T2U262">u</span> = <span class="mxinfo " id="T2:U158"><span class="mxinfo " id="T13:U159">-<span class="var type1" id="S4T13U265">Kw</span></span>*(<span class="mxinfo " id="T2:U161"><span class="var type1" id="S8T2U268">w</span> - <span class="var type1" id="S7T2U269">w_des</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">  <span class="mxinfo " id="T3:U164"><span class="var type1" id="S5T3U272">timePass1</span> = <span class="mxinfo " id="T3:U166">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">  <span class="mxinfo " id="T23:U167"><span class="var type1" id="S3T23U277">Kq</span> = <span class="var type1" id="S13T23U278">Kq_old</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">  <span class="mxinfo " id="T13:U170"><span class="var type1" id="S4T13U281">Kw</span> = <span class="var type1" id="S14T13U282">Kw_old</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line">  <span class="mxinfo " id="T3:U173"><span class="var type1" id="S5T3U285">timePass1</span> = <span class="var type1" id="S12T3U286">timePass</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line"><span class="mxinfo " id="T22:U176"><span class="var type1" id="S7T22U289">w_des</span> = <span class="mxinfo " id="T22:U178"><span class="mxinfo " id="T23:U179">-<span class="var type1" id="S3T23U292">Kq</span></span>*(<span class="mxinfo " id="T22:U181"><span class="var type1" id="S24T22U295">q</span> - <span class="var type1" id="S22T22U296">q_des</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line"><span class="var type0" id="S2T0U299">u</span> = <span class="mxinfo " id="T13:U184">-<span class="var type1" id="S4T13U302">Kw</span></span>*(<span class="message error" id="M1F1C"><span class="var type1" id="S8T2U305">w</span> - <span class="var type1" id="S7T22U306">w_des</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line"></span></span>
</pre>
