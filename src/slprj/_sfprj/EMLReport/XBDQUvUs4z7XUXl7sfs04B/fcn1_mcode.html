<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type0" id="S2T0U3">u</span>, <span class="var type1" id="S3T19U4">Kq</span>, <span class="var type1" id="S4T8U5">Kw</span>, <span class="var type1" id="S5T3U6">timePass1</span>]  = fcn(<span class="var type1" id="S6T1U9">state</span>, <span class="var type1" id="S7T2U10">w_des</span>, <span class="var type1" id="S8T2U11">w</span>, <span class="var type1" id="S9T8U12">PHI</span>, <span class="var type1" id="S10T8U13">Beuler</span>, <span class="var type1" id="S11T8U14">A_DCM</span>, <span class="var type1" id="S12T3U15">timePass</span>, <span class="var type1" id="S13T19U16">Kq_old</span>, <span class="var type1" id="S14T8U17">Kw_old</span>, <span class="var type1" id="S15T3U18">dt</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% x = [quat; ang vel]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo " id="T8:U14"><span class="var type1" id="S16T8U21">triad1</span> = <span class="mxinfo " id="T8:U16"><span class="fcn" id="F2N6:B23">getRTNTriadfromState</span>( <span class="var type1" id="S6T1U24">state</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo " id="T8:U18"><span class="var type1" id="S18T8U27">A_RTN</span> = <span class="mxinfo " id="T8:U20"><span class="fcn" id="F32N5:B29">getDCM</span>(<span class="var type1" id="S16T8U30">triad1</span>, <span class="mxinfo " id="T8:U22">eye(3)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line">coder.extrinsic(<span class="string">'dcm2quat'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo " id="T18:U23"><span class="var type1" id="S22T18U42">q_des</span> = coder.nullcopy(<span class="mxinfo " id="T18:U25">zeros(<span class="mxinfo " id="T3:U26">4</span>,1)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo " id="T18:U27"><span class="var type1" id="S24T18U53">q</span> = coder.nullcopy(<span class="mxinfo " id="T18:U29">zeros(<span class="mxinfo " id="T3:U30">4</span>,1)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo " id="T18:U31"><span class="var type1" id="S22T18U64">q_des</span> = <span class="mxinfo " id="T21:U33"><span class="extrinsicFcn" id="F54N2:B66">dcm2quat</span>(<span class="mxinfo " id="T8:U34">[<span class="mxinfo " id="T2:U35"><span class="mxinfo " id="T22:U36">[<span class="mxinfo " id="T3:U37">1</span> <span class="mxinfo " id="T3:U38">0</span> <span class="mxinfo " id="T3:U39">0</span>]</span>'</span> <span class="mxinfo " id="T2:U40"><span class="mxinfo " id="T22:U41">[<span class="mxinfo " id="T3:U42">0</span> <span class="mxinfo " id="T3:U43">0</span> <span class="mxinfo " id="T3:U44">1</span>]</span>'</span> <span class="mxinfo " id="T2:U45"><span class="mxinfo " id="T22:U46">[<span class="mxinfo " id="T3:U47">0</span> <span class="mxinfo " id="T3:U48">1</span> <span class="mxinfo " id="T3:U49">0</span>]</span>'</span>]</span>)</span></span>; <span class="comment">%dcm2quat(A_RTN);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo " id="T18:U50"><span class="var type1" id="S24T18U89">q</span> = <span class="mxinfo " id="T21:U52"><span class="extrinsicFcn" id="F55N2:B91">dcm2quat</span>(<span class="var type1" id="S11T8U92">A_DCM</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line">coder.extrinsic(<span class="string">'dlqr'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line">coder.extrinsic(<span class="string">'lqr'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T5:U54"><span class="var type1" id="S12T3U108">timePass</span> &gt; <span class="mxinfo " id="T3:U56"><span class="mxinfo " id="T3:U57">100</span>*<span class="var type1" id="S15T3U111">dt</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line">  [<span class="mxinfo " id="T19:U59"><span class="var type1" id="S26T19U115">Aquat</span></span>, <span class="mxinfo " id="T20:U61"><span class="var type1" id="S27T20U116">Aee</span></span>, <span class="mxinfo " id="T20:U63"><span class="var type1" id="S28T20U117">Bquat</span></span>] = <span class="fcn" id="F56N7:B119">linearQuat</span>( <span class="var type1" id="S24T18U120">q</span>, <span class="var type1" id="S8T2U121">w</span>, <span class="var type1" id="S15T3U122">dt</span>, <span class="var type1" id="S10T8U123">Beuler</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line">  <span class="mxinfo " id="T19:U69"><span class="var type1" id="S30T19U126">A</span> = <span class="mxinfo " id="T19:U71"><span class="var type1" id="S15T3U128">dt</span>*<span class="mxinfo " id="T19:U73">eye(4)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line">  <span class="mxinfo " id="T20:U74"><span class="var type1" id="S31T20U134">B</span> = <span class="var type1" id="S27T20U135">Aee</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">  <span class="mxinfo " id="T19:U77"><span class="var type1" id="S32T19U138">C</span> = <span class="mxinfo " id="T19:U79">eye(4)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">  <span class="mxinfo " id="T3:U80"><span class="var type1" id="S33T3U144">p</span> = <span class="mxinfo " id="T3:U82">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line">  <span class="mxinfo " id="T19:U83"><span class="var type1" id="S34T19U148">Q</span> = <span class="mxinfo " id="T19:U85"><span class="mxinfo " id="T3:U86"><span class="var type1" id="S33T3U150">p</span></span>*(<span class="mxinfo " id="T19:U88"><span class="var type1" id="S32T19U154">C</span>'*<span class="var type1" id="S32T19U155">C</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line">  <span class="mxinfo " id="T8:U91"><span class="var type1" id="S35T8U158">R</span> = <span class="mxinfo " id="T8:U93">eye(size(<span class="var type1" id="S31T20U163">B</span>,2))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">  <span class="mxinfo " id="T19:U95"><span class="var type1" id="S3T19U167">Kq</span> = coder.nullcopy(<span class="mxinfo " id="T19:U97">zeros(<span class="mxinfo " id="T3:U98">4</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">  <span class="mxinfo " id="T19:U99"><span class="var type1" id="S3T19U177">Kq</span> = <span class="mxinfo " id="T21:U101"><span class="extrinsicFcn" id="F67N3:B179">dlqr</span>(<span class="var type1" id="S30T19U180">A</span>,<span class="var type1" id="S31T20U181">B</span>,<span class="var type1" id="S34T19U182">Q</span>,<span class="var type1" id="S35T8U183">R</span>)</span></span>; <span class="comment">%discrete lqr, x_k+1 = A*x_k+B*u_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line">  <span class="mxinfo " id="T18:U106"><span class="var type1" id="S7T18U186">w_des</span> = <span class="mxinfo " id="T18:U108"><span class="mxinfo " id="T19:U109">-<span class="var type1" id="S3T19U189">Kq</span></span>*(<span class="mxinfo " id="T18:U111"><span class="var type1" id="S24T18U192">q</span> - <span class="var type1" id="S22T18U193">q_des</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">  <span class="mxinfo " id="T8:U114"><span class="var type1" id="S30T8U196">A</span> = <span class="var type1" id="S9T8U197">PHI</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">  <span class="mxinfo " id="T8:U117"><span class="var type1" id="S31T8U200">B</span> = <span class="var type1" id="S10T8U201">Beuler</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">  <span class="mxinfo " id="T8:U120"><span class="var type1" id="S32T8U204">C</span> = <span class="mxinfo " id="T8:U122">eye(3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">  <span class="mxinfo " id="T8:U123"><span class="var type1" id="S34T8U210">Q</span> = <span class="mxinfo " id="T8:U125"><span class="mxinfo " id="T3:U126"><span class="var type1" id="S33T3U212">p</span></span>*(<span class="mxinfo " id="T8:U128"><span class="var type1" id="S32T8U216">C</span>'*<span class="var type1" id="S32T8U217">C</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">  <span class="mxinfo " id="T8:U131"><span class="var type1" id="S35T8U220">R</span> = <span class="mxinfo " id="T8:U133">eye(size(<span class="var type1" id="S31T8U225">B</span>,2))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">  <span class="mxinfo " id="T8:U135"><span class="var type1" id="S4T8U229">Kw</span> = coder.nullcopy(<span class="mxinfo " id="T8:U137">zeros(<span class="mxinfo " id="T3:U138">3</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">  <span class="mxinfo " id="T8:U139"><span class="var type1" id="S4T8U239">Kw</span> = <span class="mxinfo " id="T21:U141"><span class="extrinsicFcn" id="F78N3:B241">dlqr</span>(<span class="var type1" id="S30T8U242">A</span>,<span class="var type1" id="S31T8U243">B</span>,<span class="var type1" id="S34T8U244">Q</span>,<span class="var type1" id="S35T8U245">R</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">  <span class="var type0" id="S2T0U248">u</span> = <span class="mxinfo " id="T8:U146">-<span class="var type1" id="S4T8U251">Kw</span></span>*(<span class="message error" id="M1F1C"><span class="var type1" id="S8T2U254">w</span> - <span class="var type1" id="S7T18U255">w_des</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">  <span class="mxinfo " id="T3:U150"><span class="var type1" id="S5T3U258">timePass1</span> = <span class="mxinfo " id="T3:U152">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">  <span class="mxinfo " id="T19:U153"><span class="var type1" id="S3T19U263">Kq</span> = <span class="var type1" id="S13T19U264">Kq_old</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">  <span class="mxinfo " id="T8:U156"><span class="var type1" id="S4T8U267">Kw</span> = <span class="var type1" id="S14T8U268">Kw_old</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">  <span class="mxinfo " id="T3:U159"><span class="var type1" id="S5T3U271">timePass1</span> = <span class="var type1" id="S12T3U272">timePass</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line"><span class="mxinfo " id="T18:U162"><span class="var type1" id="S7T18U275">w_des</span> = <span class="mxinfo " id="T18:U164"><span class="mxinfo " id="T19:U165">-<span class="var type1" id="S3T19U278">Kq</span></span>*(<span class="mxinfo " id="T18:U167"><span class="var type1" id="S24T18U281">q</span> - <span class="var type1" id="S22T18U282">q_des</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line"><span class="var type0" id="S2T0U285">u</span> = <span class="mxinfo " id="T8:U170">-<span class="var type1" id="S4T8U288">Kw</span></span>*(<span class="message error" id="M2F1C"><span class="var type1" id="S8T2U291">w</span> - <span class="var type1" id="S7T18U292">w_des</span></span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line"></span></span>
</pre>
